<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>LAN Party ‚Äì K√∂z√∂s Szavaz√°s</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body{font-family:Arial,sans-serif;background:#0f172a;color:#e5e7eb;display:flex;justify-content:center;padding:20px}
    .card{background:#020617;padding:20px;border-radius:12px;width:100%;max-width:760px;box-shadow:0 10px 30px rgba(0,0,0,.4)}
    h1{text-align:center;margin:0 0 10px}
    .muted{color:#94a3b8;font-size:13px}
    .hidden{display:none}
    input,button{width:100%;padding:10px;border-radius:8px;border:none;margin-top:8px;font-size:15px}
    button{background:#2563eb;color:#fff;cursor:pointer}
    button:hover{background:#1d4ed8}
    .row{display:grid;grid-template-columns:1fr;gap:8px}
    @media (min-width:560px){.row.two{grid-template-columns:1fr 1fr}}

    .toast{margin-top:10px;padding:10px;border-radius:10px;border:1px solid #1e293b;background:rgba(148,163,184,.06);font-size:13px}

    .option{background:#020617;border:1px solid #1e293b;border-radius:10px;padding:12px;margin-top:10px}
    .optionHeader{display:flex;justify-content:space-between;align-items:flex-start;gap:10px}
    .optionTitle{font-weight:700;font-size:16px}
    a{color:#60a5fa;text-decoration:none}
    a:hover{text-decoration:underline}
    .badges{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .pill{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #1e293b;color:#cbd5e1;background:rgba(148,163,184,.06);white-space:nowrap}
    .btnSmall{width:auto;padding:8px 10px;border-radius:8px;font-size:13px;margin-top:0}
    .btnGhost{background:transparent;border:1px solid #1e293b;color:#e5e7eb}
    .btnGhost:hover{background:rgba(148,163,184,.08)}
    .voters{margin-top:10px;padding-top:10px;border-top:1px dashed #1e293b;font-size:13px;color:#cbd5e1;line-height:1.35}
    .voters b{color:#e5e7eb}

    .checks{display:flex;flex-wrap:wrap;gap:12px;margin-top:8px;align-items:center}
    .check{display:flex;gap:8px;align-items:center;border:1px solid #1e293b;background:rgba(148,163,184,.04);padding:8px 10px;border-radius:10px;font-size:13px}
    .check input{width:auto;margin:0;padding:0}
  </style>
</head>
<body>
  <div class="card">
    <h1>üéÆ LAN Party Szavaz√°s</h1>
    <div class="muted" id="gateInfo"></div>
    <div class="muted" id="debug" style="margin-top:6px"></div>
    <div id="toast" class="toast hidden"></div>

    <div id="login">
      <input id="nick" placeholder="Add meg a nickneved" maxlength="24" />
      <button type="button" onclick="doLogin()">Bel√©p√©s</button>
      <div class="muted">Tipp: legyen egyedi (pl. "Pisti#1"), hogy l√°ssuk ki szavazott.</div>
    </div>

    <div id="app" class="hidden">
      <div class="row two">
        <div>
          Bel√©pve mint: <strong id="nickDisplay"></strong>
          <div class="muted">Egy opci√≥ra csak <b>egyszer</b> szavazhatsz (nicken bel√ºl), de t√∂bb opci√≥ra igen.</div>
        </div>
        <button class="btnSmall btnGhost" type="button" onclick="doLogout()">Nick v√°lt√°sa</button>
      </div>

      <div id="options"></div>

      <div style="margin-top:14px">
        <div class="muted">√öj opci√≥ hozz√°ad√°sa:</div>
        <div class="row two">
          <input id="name" placeholder="Opci√≥ neve (pl. CS2)" />
          <input id="link" placeholder="Link (Steam / trailer)" />
        </div>
        <div class="checks">
          <label class="check"><input type="checkbox" id="needBuy" /> Meg kell venni</label>
          <label class="check"><input type="checkbox" id="gamepass" /> Game Pass-os</label>
        </div>
        <button type="button" onclick="addOption()">Opci√≥ hozz√°ad√°sa</button>
        <div class="muted">Szerkeszteni csak a l√©trehoz√≥ tudja (nick alapj√°n, laza LAN m√≥d).</div>
      </div>
    </div>
  </div>

<script>
  // üîê Priv√°t link token
  const REQUIRED_TOKEN = 'lanparty2026';

  // üî• Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBEhR52XM8wMvk4zThtopiE9GtifTtFU4o",
    authDomain: "lan-party-vote.firebaseapp.com",
    databaseURL: "https://lan-party-vote-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "lan-party-vote"
  };

  // Firebase kulcs: nem lehet . # $ [ ] /
  function toSafeKey(s){ return (s||'').replace(/[\.#$\[\]\/]/g,'_'); }
  // DOM id: csak [a-zA-Z0-9_-]
  function toDomKey(s){ return String(s||'').replace(/[^a-zA-Z0-9_-]/g,'_'); }
  function escapeAttr(s){
    return String(s||'')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  // Toast
  let toastTimer=null;
  function toast(msg){
    const t=document.getElementById('toast');
    t.textContent=msg;
    t.classList.remove('hidden');
    clearTimeout(toastTimer);
    toastTimer=setTimeout(()=>t.classList.add('hidden'),2600);
  }

  // Token gate
  const params = new URLSearchParams(window.location.search);
  const tokenOk = params.get('token') === REQUIRED_TOKEN;
  const gateInfo = document.getElementById('gateInfo');
  gateInfo.textContent = tokenOk ? '‚úÖ Priv√°t link: OK' : '‚õî Nincs jogosults√°g (rossz token)';
  if(!tokenOk){
    document.getElementById('login').classList.add('hidden');
    throw new Error('Invalid token');
  }

  // Firebase init
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const ref = db.ref('votes');
  const debugEl = document.getElementById('debug');

  db.ref('.info/connected').on('value', s => {
    debugEl.textContent = s.val() ? 'üü¢ Firebase kapcsolat: OK' : 'üü† Firebase kapcsolat: nincs (bet√∂lt√©s alatt?)';
  });

  // Login state
  let currentNick = localStorage.getItem('nick') || '';
  function showApp(){
    document.getElementById('login').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    document.getElementById('nickDisplay').textContent = currentNick;
  }
  function showLogin(){
    document.getElementById('app').classList.add('hidden');
    document.getElementById('login').classList.remove('hidden');
  }

  // Global functions (onclick miatt)
  window.doLogin = function(){
    const nick = (document.getElementById('nick').value || '').trim();
    if(!nick){ toast('Adj meg egy nicknevet'); return; }
    currentNick = nick;
    localStorage.setItem('nick', nick);
    showApp();
  };

  window.doLogout = function(){
    localStorage.removeItem('nick');
    currentNick='';
    showLogin();
    toast('Nick t√∂r√∂lve');
  };

  if(currentNick) showApp();

  // Add option (safe ID + title)
  window.addOption = function(){
    if(!currentNick){ toast('El≈ëbb l√©pj be nickkel'); return; }

    const title = (document.getElementById('name').value || '').trim();
    const link = (document.getElementById('link').value || '').trim();
    const needBuy = document.getElementById('needBuy').checked;
    const gamepass = document.getElementById('gamepass').checked;
    if(!title){ toast('Adj meg egy opci√≥ nevet'); return; }

    const id = toSafeKey(title);
    ref.child(id).transaction(current => {
      if(current){
        if((!current.title || current.title==='') && title) current.title = title;
        if((!current.link || current.link==='') && link) current.link = link;
        if(!current.needBuy && needBuy) current.needBuy = true;
        if(!current.gamepass && gamepass) current.gamepass = true;
        return current;
      }
      return {
        title,
        votes: 0,
        link,
        needBuy: !!needBuy,
        gamepass: !!gamepass,
        createdBy: currentNick,
        voters: {}
      };
    });

    document.getElementById('name').value='';
    document.getElementById('link').value='';
    document.getElementById('needBuy').checked=false;
    document.getElementById('gamepass').checked=false;
    toast('‚úÖ Opci√≥ hozz√°adva');
  };

  // Vote
  function vote(optionId){
    if(!currentNick){ toast('El≈ëbb l√©pj be nickkel'); return; }
    const nickKey = toSafeKey(currentNick);
    const optionRef = ref.child(optionId);
    const voterRef = optionRef.child('voters').child(nickKey);

    voterRef.transaction(existing => {
      if(existing) return;
      return { nick: currentNick, at: Date.now() };
    }, (error, committed) => {
      if(error){ console.error(error); toast('‚õî Hiba a szavaz√°sn√°l'); return; }
      if(!committed){ toast('‚ÑπÔ∏è Erre m√°r szavazt√°l'); return; }
      optionRef.child('votes').transaction(v => (v||0)+1);
      toast('üó≥Ô∏è Szavazat r√∂gz√≠tve');
    });
  }

  // Edit
  function saveEdit(optionId){
    const panelId = `edit_${toDomKey(optionId)}`;
    const newLink = (document.getElementById(panelId + '_link').value || '').trim();
    const newNeedBuy = document.getElementById(panelId + '_needBuy').checked;
    const newGamepass = document.getElementById(panelId + '_gamepass').checked;

    ref.child(optionId).transaction(curr => {
      if(!curr) return curr;
      if(curr.createdBy !== currentNick) return curr;
      curr.link = newLink;
      curr.needBuy = !!newNeedBuy;
      curr.gamepass = !!newGamepass;
      return curr;
    }, (err, committed) => {
      if(err){ console.error(err); toast('‚õî Ment√©s hiba'); return; }
      if(committed){ toast('‚úÖ Mentve'); document.getElementById(panelId).classList.add('hidden'); }
      else toast('‚õî Nem siker√ºlt menteni');
    });
  }

  // Render (supports legacy nested paths)
  ref.on('value', snap => {
    const raw = snap.val() || {};
    const container = document.getElementById('options');
    container.innerHTML = '';

    const items = [];
    const isOptionNode = (node) => {
      if (typeof node === 'number') return true;
      return node && typeof node === 'object' && (
        Object.prototype.hasOwnProperty.call(node, 'votes') ||
        Object.prototype.hasOwnProperty.call(node, 'voters') ||
        Object.prototype.hasOwnProperty.call(node, 'createdBy') ||
        Object.prototype.hasOwnProperty.call(node, 'title')
      );
    };

    function collect(node, pathParts){
      if(node === null || node === undefined) return;
      if(typeof node === 'number'){
        const path = pathParts.join('/');
        const fallbackTitle = pathParts[pathParts.length-1] || path;
        items.push({ path, node: { title: fallbackTitle, votes: node, link:'', needBuy:false, gamepass:false, createdBy:'', voters:{} } });
        return;
      }
      if(typeof node !== 'object') return;
      if(isOptionNode(node)){
        items.push({ path: pathParts.join('/'), node });
        return;
      }
      Object.keys(node).forEach(k => collect(node[k], pathParts.concat(k)));
    }

    Object.keys(raw).forEach(k => collect(raw[k], [k]));

    if(items.length === 0){
      debugEl.textContent = (debugEl.textContent ? debugEl.textContent + ' ¬∑ ' : '') + 'üßæ 0 opci√≥ a /votes alatt';
      const empty=document.createElement('div');
      empty.className='option';
      empty.innerHTML='<div class="muted">M√©g nincs opci√≥. Adj hozz√° egyet lent üëá</div>';
      container.appendChild(empty);
      return;
    }

    items.sort((a,b)=> (b.node?.votes||0) - (a.node?.votes||0));

    const preview = items.slice(0,6).map(it => {
      const n = it.node || {};
      return (n.title && String(n.title).trim()) ? String(n.title).trim() : it.path;
    });
    debugEl.textContent = (debugEl.textContent ? debugEl.textContent.split(' ¬∑ ')[0] : '') + ` ¬∑ üßæ Bet√∂lt√∂tt opci√≥k: ${items.length}` + (preview.length ? ` ¬∑ üîé ${preview.join(' | ')}${items.length>6?' ‚Ä¶':''}` : '');

    items.forEach(({path: optionId, node: o}) => {
      const title = (o.title && String(o.title).trim()) ? String(o.title).trim() : optionId;

      const votersObj = o.voters || {};
      const voterNames = Object.values(votersObj).map(x => x && x.nick).filter(Boolean).sort((x,y)=>x.localeCompare(y,'hu'));

      const badges=[];
      badges.push(`<span class="pill">${o.votes || 0} szavazat</span>`);
      if(o.needBuy) badges.push('<span class="pill">üí∏ Meg kell venni</span>');
      if(o.gamepass) badges.push('<span class="pill">üéÆ Game Pass</span>');
      if(o.createdBy) badges.push(`<span class="pill">‚ûï ${escapeAttr(o.createdBy)}</span>`);

      const linkHtml = o.link ? `<a href="${escapeAttr(o.link)}" target="_blank" rel="noopener">üîó Link megnyit√°sa</a>` : '';
      const votersHtml = voterNames.length
        ? `<div class="voters"><b>Szavaz√≥k (${voterNames.length}):</b> ${voterNames.map(escapeAttr).join(', ')}</div>`
        : `<div class="voters"><b>Szavaz√≥k (0):</b> m√©g senki</div>`;

      const isOwner = !!currentNick && o.createdBy === currentNick;
      const editPanelId = `edit_${toDomKey(optionId)}`;

      const div=document.createElement('div');
      div.className='option';
      div.innerHTML = `
        <div class="optionHeader">
          <div style="min-width:0">
            <div class="optionTitle">${escapeAttr(title)}</div>
            ${linkHtml}
            <div class="badges">${badges.join('')}</div>
          </div>
          <div style="display:flex; gap:8px; align-items:flex-start; flex-wrap:wrap; justify-content:flex-end;">
            <button class="btnSmall" type="button" data-act="vote">Szavazok</button>
            ${isOwner ? `<button class="btnSmall btnGhost" type="button" data-act="edit">Szerkeszt√©s</button>` : ''}
          </div>
        </div>

        ${isOwner ? `
          <div id="${editPanelId}" class="hidden" style="margin-top:10px; border-top:1px dashed #1e293b; padding-top:10px;">
            <div class="muted">Szerkeszt√©s (csak a l√©trehoz√≥):</div>
            <div class="row two" style="margin-top:6px">
              <input id="${editPanelId}_link" placeholder="Link" value="${escapeAttr(o.link || '')}" />
              <div class="checks" style="margin-top:0">
                <label class="check"><input type="checkbox" id="${editPanelId}_needBuy" ${o.needBuy ? 'checked' : ''} /> Meg kell venni</label>
                <label class="check"><input type="checkbox" id="${editPanelId}_gamepass" ${o.gamepass ? 'checked' : ''} /> Game Pass-os</label>
              </div>
            </div>
            <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
              <button class="btnSmall" type="button" data-act="save">Ment√©s</button>
              <button class="btnSmall btnGhost" type="button" data-act="cancel">M√©gse</button>
            </div>
          </div>
        ` : ''}

        ${votersHtml}
      `;

      div.querySelector('button[data-act="vote"]').onclick = () => vote(optionId);

      if(isOwner){
        const panel = div.querySelector('#' + editPanelId);
        div.querySelector('button[data-act="edit"]').onclick = () => panel.classList.toggle('hidden');
        div.querySelector('button[data-act="cancel"]').onclick = () => panel.classList.add('hidden');
        div.querySelector('button[data-act="save"]').onclick = () => saveEdit(optionId);
      }

      container.appendChild(div);
    });

  }, (err)=>{
    console.error(err);
    toast('‚õî Nem tudom olvasni az adatb√°zist (Rules?)');
  });
</script>
</body>
</html>
