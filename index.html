<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>LAN Party ‚Äì K√∂z√∂s Szavaz√°s</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      padding: 20px;
    }
    .card {
      background: #020617;
      padding: 20px;
      border-radius: 12px;
      width: 100%;
      max-width: 720px;
      box-shadow: 0 10px 30px rgba(0,0,0,.4);
    }
    h1 { text-align: center; margin: 0 0 10px; }
    .muted { color: #94a3b8; font-size: 13px; }

    input, button {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: none;
      margin-top: 8px;
      font-size: 15px;
    }
    button {
      background: #2563eb;
      color: white;
      cursor: pointer;
    }
    button:hover { background: #1d4ed8; }

    .row { display: grid; grid-template-columns: 1fr; gap: 8px; }
    @media (min-width: 560px) {
      .row.two { grid-template-columns: 1fr 1fr; }
      .row.three { grid-template-columns: 1fr 1fr 1fr; }
    }

    .option {
      background: #020617;
      border: 1px solid #1e293b;
      border-radius: 10px;
      padding: 12px;
      margin-top: 10px;
    }
    .optionHeader {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
    }
    .optionTitle { font-weight: 700; font-size: 16px; }

    .badges { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
    .pill {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #1e293b;
      color: #cbd5e1;
      background: rgba(148,163,184,.06);
      white-space: nowrap;
    }

    .btnSmall {
      width: auto;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 13px;
      margin-top: 0;
    }
    .btnGhost {
      background: transparent;
      border: 1px solid #1e293b;
      color: #e5e7eb;
    }
    .btnGhost:hover { background: rgba(148,163,184,.08); }

    a { color: #60a5fa; text-decoration: none; }
    a:hover { text-decoration: underline; }

    .voters {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed #1e293b;
      font-size: 13px;
      color: #cbd5e1;
      line-height: 1.35;
    }
    .voters b { color: #e5e7eb; }

    .hidden { display: none; }

    .toast {
      margin-top: 10px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #1e293b;
      background: rgba(148,163,184,.06);
      color: #e5e7eb;
      font-size: 13px;
    }

    .checks {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 8px;
      align-items: center;
    }
    .check {
      display: flex;
      gap: 8px;
      align-items: center;
      border: 1px solid #1e293b;
      background: rgba(148,163,184,.04);
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 13px;
      color: #e5e7eb;
    }
    .check input { width: auto; margin: 0; padding: 0; }
  </style>
</head>
<body>
  <div class="card">
    <h1>üéÆ LAN Party Szavaz√°s</h1>
    <div class="muted" id="gateInfo"></div>

    <div id="login">
      <input id="nick" placeholder="Add meg a nickneved" maxlength="24" />
      <button onclick="login()">Bel√©p√©s</button>
      <div class="muted">Tipp: legyen egyedi (pl. "Pisti#1"), hogy l√°ssuk ki szavazott.</div>
    </div>

    <div id="app" class="hidden">
      <div class="row two">
        <div>
          Bel√©pve mint: <strong id="nickDisplay"></strong>
          <div class="muted">Egy opci√≥ra csak <b>egyszer</b> szavazhatsz, de t√∂bb opci√≥ra igen.</div>
        </div>
        <button class="btnSmall btnGhost" onclick="logout()">Nick v√°lt√°sa</button>
      </div>

      <div id="toast" class="toast hidden"></div>

      <div id="options"></div>

      <div style="margin-top:14px">
        <div class="muted">√öj opci√≥ hozz√°ad√°sa:</div>
        <div class="row two">
          <input id="name" placeholder="Opci√≥ neve (pl. CS2)" />
          <input id="link" placeholder="Link (Steam / trailer)" />
        </div>
        <div class="checks">
          <label class="check"><input type="checkbox" id="needBuy" /> Meg kell venni</label>
          <label class="check"><input type="checkbox" id="gamepass" /> Game Pass-os</label>
        </div>
        <button onclick="addOption()">Opci√≥ hozz√°ad√°sa</button>
        <div class="muted">Tipp: ha egy opci√≥ m√°r l√©tezik, a jel√∂l≈ëk √©s a link csak akkor friss√ºlnek, ha eddig √ºres/hamis volt.</div>
      </div>
    </div>
  </div>

<script>
  // üîê TITKOS LINK TOKEN (csak akinek megvan a link)
  const REQUIRED_TOKEN = 'lanparty2026';

  // üî• FIREBASE ‚Äì IDE A SAJ√ÅTOD
  const firebaseConfig = {
    apiKey: "AIzaSyBEhR52XM8wMvk4zThtopiE9GtifTtFU4o",
    authDomain: "lan-party-vote.firebaseapp.com",
    databaseURL: "https://lan-party-vote-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "lan-party-vote"
  };

  // -----------------------------

  // 1) Link-gate (token)
  const params = new URLSearchParams(window.location.search);
  const tokenOk = params.get('token') === REQUIRED_TOKEN;
  const gateInfo = document.getElementById('gateInfo');
  gateInfo.textContent = tokenOk ? '‚úÖ Priv√°t link: OK' : '‚õî Nincs jogosults√°g (rossz token)';
  if (!tokenOk) {
    document.getElementById('login').classList.add('hidden');
    throw new Error('Invalid token');
  }

  // 2) Firebase init
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const ref = db.ref('votes');

  // 3) Nick/login
  let currentNick = localStorage.getItem('nick');
  if (currentNick) showApp();

  function login() {
    const nick = document.getElementById('nick').value.trim();
    if (!nick) return;
    localStorage.setItem('nick', nick);
    currentNick = nick;
    showApp();
  }

  function logout() {
    localStorage.removeItem('nick');
    currentNick = null;
    location.reload();
  }

  function showApp() {
    document.getElementById('login').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    document.getElementById('nickDisplay').innerText = currentNick;
  }

  // 4) UI √ºzenet
  let toastTimer = null;
  function toast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.remove('hidden');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => t.classList.add('hidden'), 2200);
  }

  // 5) Helper: Firebase kulcs biztons√°gos (nem lehet / . # $ [ ])
  function toSafeKey(s) {
    return (s || '').replace(/[\.#$\[\]\/]/g, '_');
  }

  // 6) Opci√≥ hozz√°ad√°sa
  function addOption() {
    if (!currentNick) return;

    const name = document.getElementById('name').value.trim();
    const link = document.getElementById('link').value.trim();
    const needBuy = document.getElementById('needBuy').checked;
    const gamepass = document.getElementById('gamepass').checked;
    if (!name) return;

    ref.child(id).transaction nem tartalmazhatja: . # $ [ ] /
    // Ez√©rt az adatb√°zisban egy "biztons√°gos" ID-t haszn√°lunk, √©s elt√°roljuk a megjelen√≠tett c√≠met k√ºl√∂n.
    const id = toSafeKey(name);

    ref.child(id).transaction(current => {
      if (current) {
        if ((!current.title || current.title === '') && name) current.title = name;
        if ((!current.link || current.link === '') && link) current.link = link;
        if (!current.needBuy && needBuy) current.needBuy = true;
        if (!current.gamepass && gamepass) current.gamepass = true;
        return current;
      }
      return {
        title: name,
        votes: 0,
        link: link,
        needBuy: !!needBuy,
        gamepass: !!gamepass,
        createdBy: currentNick,
        voters: {}
      };
    });

    document.getElementById('name').value = '';
    document.getElementById('link').value = '';
    document.getElementById('needBuy').checked = false;
    document.getElementById('gamepass').checked = false;
    toast('‚úÖ Opci√≥ hozz√°adva');
  }

  // 7) Szavaz√°s: 1 nick = 1 szavazat / opci√≥
  function vote(optionId) {
    if (!currentNick) return;
    consntNick);

    const optionRef = ref.child(optionId);
    const voterRef = optionRef.child('voters').childsting => {
      if (existing) return; // m√°r szavazott
      return { nick: currentNick, at: Date.now() };
    }, (error, committed) => {
      if (error) {
        console.error(error);
        toast('‚õî Hiba a szavaz√°sn√°l');
        return;
      }
      if (!committed) {
        toast('‚ÑπÔ∏è Erre m√°r szavazt√°l');
        return;
      }
      optionRef.child('votes').transaction(v => (v || 0) + 1);
      toast('üó≥Ô∏è Szavazat r√∂gz√≠tve');
    });
  }

  // 8) Render: opci√≥k + link + jel√∂l≈ëk + szavaz√≥k
  ref.on('value', snap => {
    const data = snap.val() || {};
    const container = document.getElementById('options');
    containeap(x => x?.nick)
        .filter(Boolean)
        .sort((x, y) => x.localeCompare(y, 'hu'));

      const linkHtml = o.link
        ? `<a href="${o.link}" target="_blank" rel="noopener">üîó Link megnyit√°sa</a>`
        : '';

      const badges = [];
      badges.push(`<span classvazat</span>`);
      if (o.needBuy) badges.push(`<span class="pill">üí∏ Meg kell venni</span>`);
      if (o.gamepass) badges.push(`<span class="pill">üéÆ Game Pass</span>`);

      const votersHtml = voterNames.length
        ? `<div class="voters"><b>Szavaz√≥k (${voterNames.length}):</b> ${voterNames.join(', ')}</div>`
        : `<div class="voters"><b>Szavaz√≥k (0):</b> m√©g senki</div>`;

      const isOwner = !!currentNick && o.createdBy === currentNick;
      const displayTitle = (o.title && String(o.title).trim()) ? String(o.title).trim() : id;
      const ownerHtml = o.createdBy ? `<span class="pill">‚ûï ${o.createdBy}</span>` : '';

      const editPanelId = `edit_${toSafeKey(id)}`;

      const div = document.createElement('div');
      div.className = 'option';
      div.innerHTML = `
        <div class="optionHeadss="optionTitle">${displayTitle}</div>
            ${linkHtml}
            <div class="badges">${badges.join('')}${ownerHtml}</div>
          </div>
          <div style="display:flex; gap:8px; align-items:flex-start; flex-wrap:wrap; justify-content:fl type="button" data-action="vote">Szavazok</button>
            ${isOwner ? `<button class="btnSmall btnGhost" type="button" data-action="edit">Szerkeszt√©s</button>` : ''}
          </div>
        </div>

        <div id="${editPanelId}" class="hidden" style="margin-top:10px; border-top:1px dashed #1e293b; padding-top:10px;">
          <div class="muted">Szerkeszt√©s (csak a l√©trehoz√≥):</div>
          <div class="row two" style="margin-top:6px">
            <input id="${editPanelId}_link" placeholder="Link" value="${(o.link || '').replace(/"/g,'&quot;')}" />
            <div class="checks" style="margin-top:0">
              <label class="check"><input type="checkbox" id="${editPanelId}_needBuy" ${o.needBuy ? 'checked' : ''} /> Meg kell venni</label>
              <label class="check"><input type="checkbox" id="${editPanelId}_gamepass" ${o.gamepass ? 'checked' : ''} /> Game Pass-os</label>
            </div>
          </div>
          <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
            <button class="btnSmall" type="button" data-action="save">Ment√©s</button>
            <button class="btnSmall btnGhost" type="button" data-action="cancel">M√©gse</button>
          </div>
          <div class="muted" style="margin-top:6px">Megjegyz√©s: a szavazatok √©s a szavaz√≥k list√°ja nem v√°ltozik.</div>
        </div>

        ${votersHtml}
      `;

      const voteBtn = div.querySelector('button[data-action="vote"]');
      voteBtn.onclick = () => vote(id);

      if (isOwner) {
        const editBtn = div.querySelector('button[data-action="edit"]');
        const panel = div.querySelector(`#${editPanelId}`);
        editBtn.onclick = () => panel.classList.toggle('hidden');

        const saveBtn = div.querySelector('button[data-action="save"]');
        const cancelBtn = div.querySelector('button[data-action="cancel"]');

        cancelBtn.onclick = () => panel.classList.add('hidden');

        saveBtn.onclick = () => {
          const newLink = div.querySelector(`#${editPanelId}_link`).value.trim();
          const newNeedBuy = div.querySelector(`#${editPanelId}_needBuy`).checked;
          const newGamepass = div.querySelector(`#${editPanelId}_gamepass`).checked;

          // Csak a saj√°t opci√≥dat szerkesztheted (UI + adat oldalon is ellen≈ërizz√ºk)
          ref.child(name).transaction(curr => {
            if (!curr) return curr;
            if (curr.createdBy !== currentNick) return curr;
            curr.link = newLink;
            curr.needBuy = !!newNeedBuy;
            curr.gamepass = !!newGamepass;
            return curr;
          }, (err, committed) => {
            if (err) {
              console.error(err);
              toast('‚õî Ment√©s hiba');
              return;
            }
            if (committed) {
              toast('‚úÖ Mentve');
              panel.classList.add('hidden');
            } else {
              toast('‚õî Nem siker√ºlt menteni');
            }
          });
        };
      }

      container.appendChild(div);
    });
  });
</script>
</body>
</html>
